# **Spring Boot ì¸ì¦ ì‹œìŠ¤í…œ ì„¤ê³„ (JWT ê¸°ë°˜)**

## **1. ì¸ì¦ ì‹œìŠ¤í…œ ê°œìš”**

### âœ… ì‚¬ìš©ì ê¸°ëŠ¥

- íšŒì›ê°€ì… (ì´ë©”ì¼ ì¸ì¦ í¬í•¨)
- ë¡œê·¸ì¸ (JWT ê¸°ë°˜)
- ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸° ë° ë³€ê²½
- ë¡œê·¸ì•„ì›ƒ ë° í† í° ê´€ë¦¬
- SNS ë¡œê·¸ì¸ (OAuth2)
- ê³„ì • ë³µêµ¬ ë° íƒˆí‡´

### âœ… ë³´ì•ˆ ìš”ì†Œ

- ë¹„ë°€ë²ˆí˜¸ í•´ì‹± (BCrypt)
- JWT í† í° ê´€ë¦¬ (Access/Refresh í† í°)
- ì´ë©”ì¼ ì¸ì¦ (íšŒì›ê°€ì… & ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°)
- ë¡œê·¸ì¸ ì‹¤íŒ¨ ì œí•œ (Brute-force ë°©ì§€)
- 2FA (ì„ íƒ ì‚¬í•­)

---

## **2. ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„**

ì‚¬ìš©ì ì •ë³´ë¥¼ ì €ì¥í•  í…Œì´ë¸”ì„ ì„¤ê³„í•´ì•¼ í•œë‹¤.  
ì•„ë˜ëŠ” **PostgreSQL ë˜ëŠ” MySQL**ì„ ê¸°ì¤€ìœ¼ë¡œ í•œ ì˜ˆì œë‹¤.

```sql
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    email VARCHAR(255) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    full_name VARCHAR(100),
    role VARCHAR(50) DEFAULT 'USER',
    is_verified BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### âœ… í•„ìˆ˜ ì»¬ëŸ¼

- email: ì¤‘ë³µ ê°€ì… ë°©ì§€ë¥¼ ìœ„í•´ ìœ ë‹ˆí¬ ì†ì„± ì„¤ì •
- password: í•´ì‹±ëœ ë¹„ë°€ë²ˆí˜¸ ì €ì¥ (BCrypt ì‚¬ìš©)
- is_verified: ì´ë©”ì¼ ì¸ì¦ ì—¬ë¶€

### âœ… ì¶”ê°€ ê°€ëŠ¥ ì»¬ëŸ¼

- refresh_token: JWT ë¦¬í”„ë ˆì‹œ í† í° ì €ì¥
- last_login_at: ìµœê·¼ ë¡œê·¸ì¸ ì‹œê°„

---

## 3. Spring Security & JWT ê¸°ë°˜ ì¸ì¦ ì„¤ê³„

Spring Securityì™€ JWTë¥¼ ì´ìš©í•´ ì¸ì¦ì„ ì§„í–‰í•œë‹¤.

### ğŸ“Œ 3-1. Spring Security ì„¤ì •

```
@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        return http
            .csrf().disable()
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/auth/**").permitAll()
                .anyRequest().authenticated()
            )
            .sessionManagement(session -> session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
            .build();
    }
}

```

### âœ… ì„¤ëª…

- /auth/\*\* ê²½ë¡œëŠ” ì¸ì¦ ì—†ì´ ì ‘ê·¼ ê°€ëŠ¥
- ë‚˜ë¨¸ì§€ APIëŠ” ì¸ì¦ì´ í•„ìš”
- STATELESS ì„¤ì •ìœ¼ë¡œ ì„¸ì…˜ ê¸°ë°˜ ì¸ì¦ì„ ë¹„í™œì„±í™”í•˜ê³  JWT ì‚¬ìš©

---

### ğŸ“Œ 3-2. JWT í† í° ìƒì„± ë° ê²€ì¦

```
import io.jsonwebtoken.*;
import io.jsonwebtoken.security.Keys;
import org.springframework.stereotype.Component;

import java.security.Key;
import java.util.Date;

@Component
public class JwtUtil {
    private static final String SECRET_KEY = "your-secret-key-your-secret-key";
    private static final long EXPIRATION_TIME = 1000 * 60 * 60; // 1ì‹œê°„

    private static final Key key = Keys.hmacShaKeyFor(SECRET_KEY.getBytes());

    public String generateToken(String email) {
        return Jwts.builder()
            .setSubject(email)
            .setIssuedAt(new Date())
            .setExpiration(new Date(System.currentTimeMillis() + EXPIRATION_TIME))
            .signWith(key, SignatureAlgorithm.HS256)
            .compact();
    }

    public String validateToken(String token) {
        try {
            return Jwts.parserBuilder()
                .setSigningKey(key)
                .build()
                .parseClaimsJws(token)
                .getBody()
                .getSubject();
        } catch (JwtException e) {
            return null;
        }
    }
}
```

### âœ… ì„¤ëª…

- JWT ìƒì„± ì‹œ ì´ë©”ì¼ì„ subjectë¡œ ì €ì¥
- 1ì‹œê°„ ë™ì•ˆ ìœ íš¨í•œ í† í° ë°œê¸‰
- validateToken()ì—ì„œ í† í° ê²€ì¦

---

### ğŸ“Œ 3-3. ë¡œê·¸ì¸ API

```
@RestController
@RequestMapping("/auth")
public class AuthController {

    private final AuthenticationManager authenticationManager;
    private final JwtUtil jwtUtil;
    private final UserRepository userRepository;

    @PostMapping("/login")
    public ResponseEntity<?> login(@RequestBody LoginRequest request) {
        User user = userRepository.findByEmail(request.getEmail())
            .orElseThrow(() -> new UsernameNotFoundException("User not found"));

        if (!passwordEncoder.matches(request.getPassword(), user.getPassword())) {
            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body("Invalid credentials");
        }

        String token = jwtUtil.generateToken(user.getEmail());
        return ResponseEntity.ok(new LoginResponse(token));
    }
}

```

### âœ… ì„¤ëª…

- ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ í›„ JWT í† í° ë°˜í™˜
- ë¹„ë°€ë²ˆí˜¸ëŠ” BCryptPasswordEncoderë¡œ ê²€ì¦

---

## 4. íšŒì›ê°€ì… (ì´ë©”ì¼ ì¸ì¦ í¬í•¨)

### ğŸ“Œ 4-1. íšŒì›ê°€ì… API

```
@PostMapping("/register")
public ResponseEntity<?> register(@RequestBody RegisterRequest request) {
    if (userRepository.existsByEmail(request.getEmail())) {
        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("ì´ë¯¸ ê°€ì…ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤.");
    }

    User newUser = new User();
    newUser.setEmail(request.getEmail());
    newUser.setPassword(passwordEncoder.encode(request.getPassword()));
    newUser.setIsVerified(false);

    userRepository.save(newUser);

    // ì´ë©”ì¼ ì¸ì¦ ì½”ë“œ ì „ì†¡ (ì¶”ê°€ êµ¬í˜„ í•„ìš”)
    emailService.sendVerificationEmail(newUser.getEmail());

    return ResponseEntity.ok("íšŒì›ê°€ì… ì„±ê³µ! ì´ë©”ì¼ì„ í™•ì¸í•˜ì„¸ìš”.");
}

```

### ğŸ“Œ 4-2. ì´ë©”ì¼ ì¸ì¦ API

```
@GetMapping("/verify")
public ResponseEntity<?> verifyEmail(@RequestParam String token) {
    String email = jwtUtil.validateToken(token);
    if (email == null) {
        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("ìœ íš¨í•˜ì§€ ì•Šì€ í† í°");
    }

    User user = userRepository.findByEmail(email)
        .orElseThrow(() -> new UsernameNotFoundException("User not found"));
    user.setIsVerified(true);
    userRepository.save(user);

    return ResponseEntity.ok("ì´ë©”ì¼ ì¸ì¦ ì™„ë£Œ!");
}

```

### âœ… ì„¤ëª…

- register()ì—ì„œ íšŒì› ì •ë³´ ì €ì¥ í›„ ì´ë©”ì¼ ì¸ì¦ ë§í¬ ì „ì†¡
- verifyEmail()ì—ì„œ JWTë¥¼ ê²€ì¦í•˜ê³  isVerified ê°’ì„ trueë¡œ ë³€ê²½

---

## 5. ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸° ë° ë³€ê²½

### ğŸ“Œ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ API

```
@PostMapping("/reset-password")
public ResponseEntity<?> resetPassword(@RequestBody ResetPasswordRequest request) {
    User user = userRepository.findByEmail(request.getEmail())
        .orElseThrow(() -> new UsernameNotFoundException("User not found"));

    String resetToken = jwtUtil.generateToken(user.getEmail());
    emailService.sendPasswordResetEmail(user.getEmail(), resetToken);

    return ResponseEntity.ok("ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì´ë©”ì¼ì„ í™•ì¸í•˜ì„¸ìš”.");
}

```

### âœ… ì„¤ëª…

- ì´ë©”ì¼ë¡œ ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • í† í° ì „ì†¡
- ì‚¬ìš©ìê°€ ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ë©´ ì €ì¥

---

## 6. API ë¬¸ì„œí™”

- Java(Spring Boot)ì—ì„œë„ Springdoc OpenAPIë¥¼ ì‚¬ìš©í•˜ì—¬ Swagger ë¬¸ì„œ ìë™ ìƒì„± ê°€ëŠ¥.

```
import io.swagger.v3.oas.annotations.media.Schema;

public class LoginRequest {

    @Schema(description = "ì‚¬ìš©ì ì´ë©”ì¼", example = "user@example.com")
    private String email;

    @Schema(description = "ë¹„ë°€ë²ˆí˜¸", example = "P@ssword123")
    private String password;
}

```

---

## validation ìœ íš¨ì„± ê²€ì‚¬

ë¼ì´ë¸ŒëŸ¬ë¦¬: Jakarta Bean Validation
